<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Traumapoint</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header>
    <h1>🚑 Traumapoint</h1>
    <p>최적의 외상환자 이송 랑데부 포인트 추천</p>
  </header>

  <main>
    <input type="text" id="startInput" placeholder="출발지를 입력하세요 (예: 광명역)" />
    <button id="searchBtn">추천 받기</button>
    <div id="results"></div>
    <div id="map" style="width:100%; height:400px;"></div>
  </main>

  <!-- ✅ 1. Kakao SDK (autoload=false) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b9ccd41f81d72605a0882435c138dc91&libraries=services&autoload=false"></script>

  <!-- ✅ 2. SDK 로딩 후 앱 전체 실행 -->
  <script>
    kakao.maps.load(() => {
      // 👇 app.js 코드 직접 삽입 (script 따로 불러오지 말고 이 안에서 실행!)
      let map, geocoder, places;

      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665, 126.978),
        level: 7
      });

      geocoder = new kakao.maps.services.Geocoder();
      places = new kakao.maps.services.Places();

      const destinations = [
        { name: "인천성모병원", x: "126.678", y: "37.453" },
        { name: "송도소방서", x: "126.644", y: "37.390" },
        { name: "부천순천향병원", x: "126.775", y: "37.505" },
        { name: "부천소방서", x: "126.783", y: "37.496" },
        { name: "김포우리병원", x: "126.716", y: "37.620" },
        { name: "김포소방서", x: "126.718", y: "37.616" }
      ];

      function findTraumapoint() {
        const keyword = document.getElementById('startInput').value;

        places.keywordSearch(keyword, (data, status) => {
          if (status !== kakao.maps.services.Status.OK || !data.length) {
            alert("출발지를 찾을 수 없습니다.");
            return;
          }

          const place = data[0];
          const origin = { x: place.x, y: place.y };

          fetch('/api/traumapoint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ origin, destinations })
          })
            .then(res => res.json())
            .then(data => showResults(data.routes))
            .catch(err => {
              console.error(err);
              alert("추천 실패. 다시 시도해주세요.");
            });
        });
      }

      function showResults(routes) {
        const container = document.getElementById('results');
        container.innerHTML = '';
        routes.sort((a, b) => a.summary.duration - b.summary.duration);

        routes.forEach(r => {
          const min = Math.floor(r.summary.duration / 60);
          container.innerHTML += `<p>🚨 ${r.key} : 약 ${min}분 소요</p>`;
        });
      }

      // 버튼 클릭 이벤트 연결
      document.getElementById('searchBtn').addEventListener('click', findTraumapoint);
    });
  </script>
</body>
</html>
